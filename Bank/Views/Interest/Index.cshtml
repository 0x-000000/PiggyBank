@{
    ViewBag.Title = "Interest Calculator";
    var userCookie = Request.Cookies["user"];
    var bank = new Bank.Models.BankSystem();
    bool isLoggedIn = userCookie != null && !string.IsNullOrEmpty(userCookie.Value);
    string username = isLoggedIn ? userCookie.Value : "";
    var account = isLoggedIn ? bank.GetAccount(username) : null;
    string type = account?.AccountType ?? "";
}

<style>
    .view-panel {
        flex: 1;
        align-items: stretch;
        width: 400px;
        padding: 12px 16px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f8f9fa;
        min-width: 220px;
        max-width: 735px;
    }

        .view-panel p {
            margin: 4px 0;
        }

    .input-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin: 4px 0;
    }

        .input-row > * {
            margin: 0;
            line-height: 1.2;
        }

        .input-row input[type="number"] {
            max-width: 120px;
            text-align: right;
        }

        .input-row input[type="text"] {
            max-width: 180px;
            text-align: right;
        }

        .input-row span {
            margin-bottom: 2px;
        }

    .button-row {
        margin-top: 8px;
    }

    .amount-input {
        border-radius: 4px;
        border: 1px solid #303030;
        padding: 2px 6px;
    }

        .amount-input::-webkit-outer-spin-button,
        .amount-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .amount-input[type=number] {
            -moz-appearance: textfield;
        }
</style>

<h2>Interest Calculator</h2>
<div class="view-panel">
    <form id="interestForm">
        <p class="input-row">
            <span>Balance </span>
            <input type="number" id="balance" class="amount-input mb-1" placeholder="0" required />
        </p>
        <p class="input-row">
            <span>Annual Rate (%)</span>
            <input type="number" id="rate" class="amount-input mb-1" placeholder="0" required />
        </p>
        <p class="input-row">
            <span>Years </span>
            <input type="number" id="years" min="0" class="amount-input mb-1" placeholder="0" required />
        </p>
        <p class="input-row mb-3">
            <span>Compounds / Year</span>
            <input type="number" id="compounds" min="1" value="12" class="amount-input mb-1" required />
        </p>
        <p class="button-row d-flex align-items-center">
            <button type="submit" class="btn btn-secondary" style="padding: 0.1rem 0.5rem;">Calculate</button>
            <label id="interestResult" class="ms-auto"></label>
        </p>
    </form>
</div>


@section Scripts {
    <script>
        (function () {
            var form = document.getElementById("interestForm");
            var output = document.getElementById("interestResult");
            var endpoint = '@Url.Action("Calculate", "Interest")';

            if (!form || !output) {
                return;
            }

            form.addEventListener("submit", function (e) {
                e.preventDefault();

                var payload = {
                    balance: parseFloat(document.getElementById("balance").value),
                    rate: parseFloat(document.getElementById("rate").value),
                    years: parseInt(document.getElementById("years").value, 10),
                    compoundsPerYear: parseInt(document.getElementById("compounds").value, 10)
                };

                if (isNaN(payload.balance) || isNaN(payload.rate) || isNaN(payload.years) || isNaN(payload.compoundsPerYear)) {
                    output.textContent = "Please type numbers in every box.";
                    return;
                }

                output.textContent = "Calling service...";

                fetch(endpoint, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                })
                    .then(function (res) { return res.json().then(function (data) { return { ok: res.ok, data: data }; }); })
                    .then(function (response) {
                        if (!response.ok) {
                            output.textContent = response.data && response.data.error ? response.data.error : "Something broke????";
                            return;
                        }

                        output.textContent = "Calculated Interest: $" + response.data.result;
                    })
                    .catch(function (err) {
                        output.textContent = err.message || "Network fail";
                    });
            });
        })();
    </script>
}
