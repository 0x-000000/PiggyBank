@{
    // This page handles the Member View page UI and the code logic behind it
    ViewBag.Title = "Member";
    var username = ViewBag.Username as string ?? "unknown";
    var type = ViewBag.AccountType as string ?? "member";
}

<!-- This section helps styling the HTML page and makes it look prettier -->
<style>
    .master-view {
        margin-top: 20px;
        font-family: "Segoe UI", Arial, sans-serif;
    }

    .greeting {
        margin-bottom: 20px;
    }

    .outer-row {
        display: flex;
        align-items: flex-start;
        gap: 80px;
        margin-bottom: 15px;
    }

    .inner-row {
        display: flex;
        align-items: flex-start;
        gap: 20px;
        margin-bottom: 10px;
    }

    .view-panel {
        padding: 12px 16px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f8f9fa;
        min-width: 220px;
    }

        .view-panel p {
            margin: 4px 0;
        }

        .view-panel h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

    .input-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin: 4px 0;
    }

        .input-row > * {
            margin: 0;
            line-height: 1.2;
        }

        .input-row input[type="number"] {
            max-width: 120px;
            text-align: right;
        }

        .input-row input[type="text"] {
            max-width: 160px;
            text-align: right;
        }

        .input-row span {
            margin-bottom: 2px;
        }

    .textarea1-output {
        width: 200px;
        height: 128px;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 4px 6px;
        resize: none;
        font-size: 0.8rem;
    }

    .textarea2-output {
        width: 200px;
        height: 160px;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 4px 6px;
        resize: none;
        font-size: 0.8rem;
    }

    .balance-output {
        display: inline-block;
        min-width: 200px;
        padding: 2px 8px;
        border: 1px solid #ccc;
        text-align: right;
        border-radius: 4px;
        margin-bottom: 4px;
    }

    .button-row {
        margin-top: 8px;
    }

    .amount-input {
        border-radius: 4px;
        border: 1px solid #000;
        padding: 2px 6px;
    }

        .amount-input::-webkit-outer-spin-button,
        .amount-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .amount-input[type=number] {
            -moz-appearance: textfield;
        }
</style>

<div class="master-view">
    <p class="greeting">
        <h5>Hello, @username (@type) </h5>
        This is the member page for our application, which can be accessed by both Staff <br />
        accounts and Members accounts. In order to access this page, you must first be logged <br />
        in. This page provides four basic functionalities. It includes a balance checking <br />
        service, a deposit service, a withdrawal service, and a transfer service. These services <br />
        are able to modify the data stored in the XML files on the server through API calls. <br />
        Account Balance is used to refresh and update the balance of the user in case if another <br />
        account transfers money to the current account. Deposit is able to simulate basic <br />
        deposits by adding the specified amount to the user's balance. Withdraw is able to <br />
        simulate basic withdrawals by subtracting the specified amount from the user's balance. <br />
        Transfer is able to move money between accounts by subtracting the specified amount from <br />
        the users account and adding it to the specified user's account. <br />
        The Interest and Tax methods can be accessed through the top navigation bar. <br />
    </p>

    <!-- Row 1 -->
    <!-- This row contains Account Balance -->
    <div class="outer-row mb-4">
        <div class="view-panel">
            <h3>Account Balance</h3>
            <form id="balanceForm">
                <p>
                    <span id="balanceResult" class="balance-output">
                        0.00
                    </span>
                </p>
                <p class="button-row">
                    <button type="submit" class="btn btn-secondary float-end" style="padding: 0.1rem 0.5rem;">
                        Refresh Balance
                    </button>
                </p>
            </form>
        </div>
    </div>

    <!-- Row 2 -->
    <!-- This row contains the Deposit and Withdraw panels -->
    <div class="outer-row">
        <!-- Deposit Panel -->
        <div class="view-panel">
            <div class="inner-row">
                <div class="view-panel">
                    <h3>Deposit</h3>
                    <form id="depositForm">
                        <p class="input-row mb-1">
                            <span>Amount</span>
                            <input type="number" id="depositAmount" class="amount-input mb-1" placeholder="0"
                                   required />
                        </p>
                        <p class="button-row">
                            <button type="submit" class="btn btn-secondary" style="padding: 0.1rem 0.5rem;">
                                Deposit
                            </button>
                        </p>
                    </form>
                </div>

                <textarea id="depositResult" class="textarea1-output" readonly>
                </textarea>
            </div>
        </div>

        <!-- Withdraw Panel -->
        <div class="view-panel">
            <div class="inner-row">
                <div class="view-panel">
                    <h3>Withdraw</h3>
                    <form id="spendForm">
                        <p class="input-row mb-1">
                            <span>Amount</span>
                            <input type="number" id="spendAmount" class="amount-input mb-1" placeholder="0" required />
                        </p>
                        <p class="button-row">
                            <button type="submit" class="btn btn-secondary" style="padding: 0.1rem 0.5rem;">
                                Withdraw
                            </button>
                        </p>
                    </form>
                </div>
                <div>
                    <textarea id="spendResult" class="textarea1-output" readonly></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 3 -->
    <!-- This row contains the Transfer Funds panel -->
    <div class="outer-row">
        <!-- Transfer Panel -->
        <div class="view-panel">
            <div class="inner-row">
                <div class="view-panel">
                    <h3>Transfer</h3>
                    <form id="transferForm">
                        <p class="input-row">
                            <span>Send to Username</span>
                            <input type="text" id="transferToUser" class="amount-input mb-1"
                                   placeholder="Enter Username" required />
                        </p>
                        <p class="input-row mb-1">
                            <span>Amount</span>
                            <input type="number" id="transferAmount" class="amount-input mb-1" placeholder="0"
                                   required />
                        </p>
                        <p class="button-row">
                            <button type="submit" class="btn btn-secondary" style="padding: 0.1rem 0.5rem;">
                                Send
                            </button>
                        </p>
                    </form>
                </div>
                <div>
                    <textarea id="transferResult" class="textarea2-output" readonly></textarea>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var apiBase = '@Url.Content("~/api/bank/")';

        // This function helps send requests
        function send(endpoint, payload, outputId, transform) {
            var box = document.getElementById(outputId);
            fetch(apiBase + endpoint, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            })
                .then(function (res) { return res.text(); })
                .then(function (text) {
                    var output = (typeof transform === "function") ? transform(text) : text;
                    if ("value" in box) {
                        box.value = output;
                    } else {
                        box.textContent = output;
                    }
                })
                .catch(function (err) {
                    if ("value" in box) {
                        box.value = err.message;
                    } else {
                        box.textContent = err.message;
                    }
                });
        }

        // This function helps format the Balance Responses received
        function formatBalanceResponse(text) {
            try {
                var obj = JSON.parse(text);
                var num = obj.balance;
                return "$" + num.toFixed(2);
            } catch (e) {
                return text;
            }
        }

        // This function helps format the Balance update part of the Deposit, Withdraw, and 
        // transfer functions
        function formatDefaultResponse(text) {
            send("balance",
                { targetUsername: "" },
                "balanceResult",
                formatBalanceResponse
            );
            try {
                var obj = JSON.parse(text);
                var msg = obj.message || obj.Message || "";
                if (!("balance" in obj)) {
                    return msg || text;
                }
                var balanceLine = "New balance: $" + obj.balance.toFixed(2);
                return msg + "\n" + balanceLine;
            } catch (e) {
                return text;
            }
        }

        // This function handles what happens when the Deposit button is clicked
        document.getElementById("depositForm").addEventListener("submit", function (e) {
            e.preventDefault();
            send("deposit", {
                amount: Number(document.getElementById("depositAmount").value),
                targetUsername: ""
            }, "depositResult", formatDefaultResponse);

            document.getElementById("depositAmount").value = null;
        });

        // This function handles what happens when the Withdraw button is clicked
        document.getElementById("spendForm").addEventListener("submit", function (e) {
            e.preventDefault();
            send("spend", {
                amount: Number(document.getElementById("spendAmount").value),
                targetUsername: ""
            }, "spendResult", formatDefaultResponse);

            document.getElementById("spendAmount").value = null;
        });

        // This function handles what happens when the Refresh Balance button is clicked
        document.getElementById("balanceForm").addEventListener("submit", function (e) {
            e.preventDefault();
            send(
                "balance",
                { targetUsername: "" },
                "balanceResult",
                formatBalanceResponse
            );
        });

        // This function handles what happens when the Send button is clicked
        document.getElementById("transferForm").addEventListener("submit", function (e) {
            e.preventDefault();
            send("transfer", {
                fromUsername: "",
                toUsername: document.getElementById("transferToUser").value,
                amount: Number(document.getElementById("transferAmount").value)
            }, "transferResult", formatDefaultResponse);

            document.getElementById("transferAmount").value = null;
        });

        // This function helps automatically update the Account Balance once the page is
        // first initialized. 
        send("balance",
            { targetUsername: "" },
            "balanceResult",
            formatBalanceResponse
        );

    </script>
}