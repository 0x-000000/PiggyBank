@{
    ViewBag.Title = "Member";
    var username = ViewBag.Username as string ?? "unknown";
    var type = ViewBag.AccountType as string ?? "member";
}

<style>
    .member-view {
        margin-top: 20px;
        font-family: "Segoe UI", Arial, sans-serif;
    }

    .greeting {
        margin-bottom: 20px;
    }

    .outer-row {
        display: flex;
        align-items: flex-start;
        gap: 80px;
        margin-bottom: 28px;
    }

    .inner-row {
        display: flex;
        align-items: flex-start;
        gap: 20px;
        margin-bottom: 10px;
    }

    .member-panel {
        padding: 12px 16px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f8f9fa;
        min-width: 220px;
    }

    .member-panel p {
        margin: 4px 0;
    }

    .member-panel h3 {
        margin-top: 0;
        margin-bottom: 10px;
        font-size: 1.3rem;
    }

    .input-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin: 4px 0;
    }

    .input-row > * {
        margin: 0; /* remove default paragraph/label margins */
        line-height: 1.2; /* keeps text from looking “off-center” */
    }

    .input-row input[type="number"] {
        max-width: 120px;
        text-align: right;
    }

    .input-row input[type="text"] {
        max-width: 160px;
        text-align: right;
    }

    .input-row span {
        margin-bottom: 2px;
    }

    .textarea1-output {
        width: 200px;
        height: 128px;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 4px 6px;
        resize: none;
        font-size: 0.8rem;
    }

    .textarea2-output {
        width: 200px;
        height: 164px;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 4px 6px;
        resize: none;
        font-size: 0.8rem;
    }

    .balance-output {
        display: inline-block;
        min-width: 200px;
        padding: 2px 8px;
        border: 1px solid #ccc;
        text-align: right;
        border-radius: 4px;
        margin-bottom: 4px;
    }

    .button-row {
        margin-top: 8px;
    }

    .amount-input {
        border-radius: 4px;
        border: 1px solid #000;
        padding: 2px 6px;
    }

    .amount-input::-webkit-outer-spin-button,
    .amount-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .amount-input[type=number] {
        -moz-appearance: textfield;
    }
</style>

<div class="member-view">
    <p class="greeting">
        Hello, @username (@type)
    </p>

    <!-- Row 1 -->
    <div class="outer-row">
        <div class="member-panel">
            <h3>Account Balance</h3>
            <form id="balanceForm">
                <p>
                    <span id="balanceResult" class="balance-output">
                        0.00
                    </span>
                </p>
                <p class="button-row">
                    <button type="submit" class="btn btn-secondary float-end" style="padding: 0.1rem 0.5rem;">
                        Refresh Balance
                    </button>
                </p>
            </form>
        </div>
    </div>

    <!-- Row 2 -->
    <div class="outer-row">
        <!-- Deposit Panel -->
        <div class="member-panel">
            <div class="inner-row">
                <div class="member-panel">
                    <h3>Deposit</h3>
                    <form id="depositForm">
                        <p class="input-row mb-1">
                            <span>Amount</span>
                            <input type="number" id="depositAmount" class="amount-input mb-1" placeholder="0" required />
                        </p>
                        <p class="button-row">
                            <button type="submit" class="btn btn-secondary" style="padding: 0.1rem 0.5rem;">
                                Deposit
                            </button>
                        </p>
                    </form>
                </div>

                <textarea id="depositResult"
                          class="textarea1-output"
                          readonly>
                </textarea>
            </div>
        </div>

        <!-- Withdraw Panel -->
        <div class="member-panel">
            <div class="inner-row">
                <div class="member-panel">
                    <h3>Withdraw</h3>
                    <form id="spendForm">
                        <p class="input-row mb-1">
                            <span>Amount</span>
                            <input type="number" id="spendAmount" class="amount-input mb-1" placeholder="0" required />
                        </p>
                        <p class="button-row">
                            <button type="submit" class="btn btn-secondary" style="padding: 0.1rem 0.5rem;">
                                Withdraw
                            </button>
                        </p>
                    </form>
                </div>
                <div>
                    <textarea id="spendResult"
                              class="textarea1-output"
                              readonly></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 3 -->
    <div class="outer-row">
        <!-- Transfer Panel -->
        <div class="member-panel">
            <div class="inner-row">
                <div class="member-panel">
                    <h3>Transfer</h3>
                    <form id="transferForm">
                        <p class="input-row">
                            <span>Send to Username</span>
                            <input type="text" id="transferToUser" class="amount-input mb-1" placeholder="Enter Username" required />
                        </p>
                        <p class="input-row mb-1">
                            <span>Amount</span>
                            <input type="number" id="transferAmount" class="amount-input mb-1" placeholder="0" required />
                        </p>
                        <p class="button-row">
                            <button type="submit" class="btn btn-secondary" style="padding: 0.1rem 0.5rem;">
                                Send
                            </button>
                        </p>
                    </form>
                </div>
                <div>
                    <textarea id="transferResult"
                              class="textarea2-output"
                              readonly></textarea>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var apiBase = '@Url.Content("~/api/bank/")';

        function send(endpoint, payload, outputId, transform) {
            var box = document.getElementById(outputId);
            fetch(apiBase + endpoint, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            })
                .then(function (res) { return res.text(); })
                .then(function (text) {
                    var output = (typeof transform === "function") ? transform(text) : text;

                    if ("value" in box) {
                        box.value = output;
                    } else {
                        box.textContent = output;
                    }
                })
                .catch(function (err) {
                    if ("value" in box) {
                        box.value = err.message;
                    } else {
                        box.textContent = err.message;
                    }
                });
        }

        function formatBalanceResponse(text) {
            try {
                var obj = JSON.parse(text);
                var num = obj.balance;
                return "$" + num.toFixed(2);
            } catch (e) {
                return text;
            }
        }

        function formatDefaultResponse(text) {
            send("balance",
                { targetUsername: "" },
                "balanceResult",
                formatBalanceResponse
            );
            try {
                var obj = JSON.parse(text);
                var msg = obj.message || obj.Message || "";
                if (!("balance" in obj)) {
                    return msg || text;
                }
                var balanceLine = "New balance: $" + obj.balance.toFixed(2);
                return msg + "\n" + balanceLine;
            } catch (e) {
                return text;
            }
        }

        document.getElementById("depositForm").addEventListener("submit", function (e) {
            e.preventDefault();
            send("deposit", {
                amount: Number(document.getElementById("depositAmount").value),
                targetUsername: ""
            }, "depositResult", formatDefaultResponse);

            document.getElementById("depositAmount").value = null;
        });

        document.getElementById("spendForm").addEventListener("submit", function (e) {
            e.preventDefault();
            send("spend", {
                amount: Number(document.getElementById("spendAmount").value),
                targetUsername: ""
            }, "spendResult", formatDefaultResponse);

            document.getElementById("spendAmount").value = 0;
        });

        document.getElementById("balanceForm").addEventListener("submit", function (e) {
            e.preventDefault();
            send(
                "balance",
                { targetUsername: "" },
                "balanceResult",
                formatBalanceResponse
            );
        });

        document.getElementById("transferForm").addEventListener("submit", function (e) {
            e.preventDefault();
            send("transfer", {
                fromUsername: "",
                toUsername: document.getElementById("transferToUser").value,
                amount: Number(document.getElementById("transferAmount").value)
            }, "transferResult", formatDefaultResponse);

            document.getElementById("transferAmount").value = 0;
        });

        send("balance",
            { targetUsername: "" },
            "balanceResult",
            formatBalanceResponse
        );

    </script>
}
