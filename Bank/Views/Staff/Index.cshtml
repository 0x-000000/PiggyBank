@{
    // This page handles the UI of the Staff page and the code logic behind it
    ViewBag.Title = "Staff";
    var username = ViewBag.Username as string ?? "unknown";
    var type = ViewBag.AccountType as string ?? "member";
}

<!-- This section helps styling the HTML page and makes it look prettier -->
<style>
    .master-view {
        margin-top: 20px;
        font-family: "Segoe UI", Arial, sans-serif;
    }

    .greeting {
        margin-bottom: 20px;
    }

    .outer-row {
        display: flex;
        align-items: flex-start;
        gap: 80px;
        margin-bottom: 28px;
    }

    .inner-row {
        display: flex;
        align-items: stretch;
        gap: 20px;
        margin-bottom: 10px;
    }

    .view-panel {
        flex: 1;
        align-items: stretch;
        padding: 12px 16px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f8f9fa;
        min-width: 220px;
        max-width: 735px;
    }

        .view-panel p {
            margin: 4px 0;
        }

        .view-panel h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }

    .input-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin: 4px 0;
    }

        .input-row > * {
            margin: 0;
            line-height: 1.2;
        }

        .input-row input[type="number"] {
            max-width: 120px;
            text-align: right;
        }

        .input-row input[type="text"] {
            max-width: 180px;
            text-align: right;
        }

        .input-row span {
            margin-bottom: 2px;
        }

    .textarea1-output {
        align-items: stretch;
        width: 200px;
        height: 100%;
        max-height: 160px;
        box-sizing: border-box;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 4px 6px;
        resize: none;
        font-size: 0.8rem;
    }

    .balance-output {
        display: inline-block;
        min-width: 200px;
        padding: 2px 8px;
        border: 1px solid #ccc;
        text-align: right;
        border-radius: 4px;
        margin-bottom: 4px;
    }

    .button-row {
        margin-top: 8px;
    }

    .amount-input {
        border-radius: 4px;
        border: 1px solid #000;
        padding: 2px 6px;
    }

        .amount-input::-webkit-outer-spin-button,
        .amount-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .amount-input[type=number] {
            -moz-appearance: textfield;
        }
</style>

<div class="master-view">
    <p class="greeting">
        <h5>Hello, @username (@type)</h5>
        This is the Staff view for our application. It is only accessible if the currently <br />
        logged in account is a Staff type account. On this page, you can adjust the <br />
        privilege level of accounts by demoting and promoting them. Additionally, on this <br />
        page, you can manually transfer funds between accounts and check the balance of <br />
        any account. <br />
    </p>

    <!-- Row 1 -->
    <!-- Contains Fund Transfering Method -->
    <div class="outer-row">
        <div class="view-panel">
            <div class="inner-row">
                <div class="view-panel">
                    <h3>Transfer</h3>
                    <form id="transferForm">
                        <p class="input-row">
                            <span>From Username (blank = yourself)</span>
                            <input type="text" id="transferFromUser" class="amount-input mb-1"
                                   placeholder="Enter From Username" />
                        </p>
                        <p class="input-row">
                            <span>To Username</span>
                            <input type="text" id="transferToUser" class="amount-input mb-1"
                                   placeholder="Enter To Username" required />
                        </p>
                        <p class="input-row">
                            <span>Amount</span>
                            <input type="number" id="transferAmount" class="amount-input mb-1" placeholder="0"
                                   required />
                        </p>
                        <p class="button-row">
                            <button type="submit" class="btn btn-secondary" style="padding: 0.1rem 0.5rem;">
                                Transfer
                            </button>
                        </p>
                    </form>
                </div>
                <div>
                    <textarea id="transferResult" class="textarea1-output" readonly></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 2 -->
    <!-- Contains Balance Checking Method -->
    <div class="outer-row">
        <div class="view-panel">
            <div class="inner-row">
                <div class="view-panel">
                    <h3>Check Balance</h3>
                    <form id="staffBalanceForm">
                        <p class="input-row">
                            <span>Target Username (blank = yourself) </span>
                            <input type="text" id="staffBalanceUser" class="amount-input mb-1"
                                   placeholder="Enter Username" />
                        </p>
                        <p class="button-row">
                            <button type="submit" class="btn btn-secondary" style="padding: 0.1rem 0.5rem;">
                                Check
                            </button>
                        </p>
                    </form>
                </div>
                <div>
                    <textarea id="staffBalanceResult" class="textarea1-output" readonly></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 3 -->
    <!-- Contains Role Changing Method -->
    <div class="outer-row">
        <div class="view-panel">
            <div class="inner-row">
                <div class="view-panel">
                    <h3>Role Change</h3>
                    <p>Select a user to change roles</p>
                    <div class="inner-row">
                        <div class="view-panel">
                            <h4>Members</h4>
                            <div id="memberList"></div>
                        </div>
                        <div class="view-panel">
                            <h4>Admins</h4>
                            <div id="adminList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var staffApiBase = '@Url.Content("~/api/bank/")';

        // This function is used to handle the message received from API requests
        function run(endpoint, payload, outputId, transform) {
            var box = document.getElementById(outputId);

            return fetch(staffApiBase + endpoint, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            })
                .then(function (res) { return res.text(); })
                .then(function (text) {
                    var output = (typeof transform === "function") ? transform(text) : text;
                    if ("value" in box) {
                        box.value = output;
                    } else {
                        box.textContent = output;
                    }
                });
        }

        // This function helps send requests
        function send(endpoint, payload) {
            return fetch(staffApiBase + endpoint, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            }).then(function (res) { return res.text(); });
        }

        // This function handles the response received from doing a Balance request
        function formatBalanceResponse(text) {
            var obj = JSON.parse(text);
            var msg = obj.message;
            var user = obj.username;
            var num = obj.balance;
            return msg + "\n" + user + "\n" + "$" + num.toFixed(2);
        }

        // This function handles promoting a user
        function promoteUser(name) {
            send("promote", { targetUsername: name }).then(loadUsers);
        }

        // This function handles demoting a user
        function demoteUser(name) {
            send("demote", { targetUsername: name }).then(loadUsers);
        }

        // This function displays the accounts in the Role Change panel
        function renderList(targetId, users, mode) {
            var box = document.getElementById(targetId);
            var html = "";
            for (var i = 0; i < users.length; i++) {
                var u = users[i];
                var btn = "";
                if (mode === "promote") {
                    btn = "<button type=\"button\" class=\"btn btn-primary btn-sm\" onclick=\"promoteUser('" + u.username + "')\">Promote</button>";
                } else {
                    btn = "<button type=\"button\" class=\"btn btn-secondary btn-sm\" onclick=\"demoteUser('" + u.username + "')\">Demote</button>";
                }
                html += "<div class=\"input-row\"><span>" + u.username + "</span>" + btn + "</div>";
            }

            box.innerHTML = html;   // the evil and intimidating xss
        }

        // This function helps load the list of users to be displayed in the Role panel
        function loadUsers() {
            fetch(staffApiBase + "users")
                .then(function (res) { return res.json(); })
                .then(function (list) {
                    var members = [];
                    var admins = [];
                    for (var i = 0; i < list.length; i++) {
                        var u = list[i];
                        if ((u.accountType || "").toLowerCase() === "admin") {
                            admins.push(u);
                        } else {
                            members.push(u);
                        }
                    }

                    renderList("memberList", members, "promote");
                    renderList("adminList", admins, "demote");
                });
        }

        // This function helps manage the response received from doing a Transfer
        function formatTransferResponse(text) {
            var obj = JSON.parse(text);
            var msg = obj.message;

            var from = obj.from;
            var to = obj.to;

            var fromUser = from.username;
            var fromBalance = (from.balance || 0).toFixed(2);

            var toUser = to.username;
            var toBalance = (to.balance || 0).toFixed(2);

            var output = [];

            output.push(msg);

            var fromLine = "From: \t" + fromUser + "\n";
            fromLine += "Balance - $" + fromBalance + "\n";
            output.push(fromLine);

            var toLine = "To: \t\t" + toUser + "\n";
            toLine += "Balance - $" + toBalance;
            output.push(toLine);

            return output.join("\n");
        }

        // This function handles what happens when the Transfer button is clicked
        document.getElementById("transferForm").addEventListener("submit", function (e) {
            e.preventDefault();
            run("transfer", {
                fromUsername: document.getElementById("transferFromUser").value,
                toUsername: document.getElementById("transferToUser").value,
                amount: Number(document.getElementById("transferAmount").value)
            }, "transferResult", formatTransferResponse);

            document.getElementById("transferAmount").value = null;
        });

        // This function handles what happens when the Check Balance button is clicked
        document.getElementById("staffBalanceForm").addEventListener("submit", function (e) {
            e.preventDefault();
            run("balance", {
                targetUsername: document.getElementById("staffBalanceUser").value
            }, "staffBalanceResult", formatBalanceResponse);
        });

        loadUsers();
    </script>
}